# Задачи: Добавление Telegram-бота для напоминаний

Задачи разделены на группы. Задачи внутри одной группы можно выполнять параллельно. Группы следует выполнять последовательно.

## Группа 1: Инфраструктура и логика парсинга (Параллельно)

- **Задача 1.1: Миграции базы данных (Liquibase)**
  - Создать новый changelog файл `YYYYMMDDHHMMSS_add_telegram_tables.xml`.
  - Добавить колонку `telegram_id` (BIGINT, UNIQUE) в таблицу `member`.
  - Создать таблицу `pending_link` (id, member_id, code, created_at, expires_at, used).
  - Создать таблицу `polling_state` (id, last_update_id).
- **Задача 1.2: Telegram REST Client & DTOs**
  - В пакете `org.manage.client.dto` создать POJO для Telegram API (Update, Message, User, Chat, SendMessageRequest).
  - В пакете `org.manage.client` создать интерфейс `TelegramBotClient` с аннотациями `@RegisterRestClient`.
- **Задача 1.3: Компонент парсинга сообщений**
  - Создать `TelegramMessageParser`.
  - Реализовать поддержку форматов, аналогичных фронтенду:
    - `Ч:ММ` (например, `2:30`)
    - Натуральный ввод с единицами: `2ч 30м`, `1.5h`, `90м` и т.д.
    - Поддержка кириллицы (`ч`, `м`) и латиницы (`h`, `m`).
  - Реализовать нормализацию и маппинг символов (аналог `formatDuration` в `date-utils.ts`).
  - Написать Unit-тесты для покрытия различных вариантов ввода.

## Группа 2: Сущности и модели (После 1.1)

- **Задача 2.1: Сущности Panache**
  - Обновить `Member.java`: добавить поле `telegramId`.
  - Создать `PendingLink.java` с необходимыми связями.
  - Создать `PollingState.java`.

## Группа 3: Бизнес-логика (После 1.2, 1.3, 2.1)

- **Задача 3.1: Сервис привязки (TelegramLinkService)**
  - Реализовать метод генерации уникального кода привязки.
  - Реализовать метод подтверждения привязки при получении кода из бота.
  - Реализовать периодическую очистку (`@Scheduled`) устаревших или использованных кодов из `pending_link`.
- **Задача 3.2: Обработчик сообщений (TelegramMessageHandler)**
  - Реализовать логику обработки команд `/start <код>`, `/today`, `/help`.
  - Реализовать сохранение `TimeEntry` через существующий `TimeEntryService` при получении валидного сообщения с временем.
- **Задача 3.3: REST-ресурс для генерации ссылок**
  - Создать `TelegramResource` с эндпоинтом `POST /api/telegram/generate-link`.
  - Реализовать формирование ссылки вида `https://t.me/<bot_username>?start=<code>`.

## Группа 4: Интеграция и интерфейс (После 3.1, 3.2)

- **Задача 4.1: Сервис опроса (TelegramPollingService)**
  - Реализовать периодический опрос Telegram API через `@Scheduled`.
  - Сохранение и загрузка `last_update_id` из `PollingState`.
- **Задача 4.2: Сервис напоминаний (ReminderService)**
  - Настроить cron-задачу для проверки заполнения времени.
  - Рассылка сообщений через `TelegramBotClient` тем, кто не заполнил время.
- **Задача 4.3: Пользовательский интерфейс (React)**
  - Добавить в настройки профиля секцию "Telegram Bot".
  - Реализовать вызов `POST /api/telegram/generate-link`.
  - Отображать кликабельную ссылку или кнопку «Перейти в Telegram» и срок действия кода.

## Группа 5: Стабилизация

- **Задача 5.1: Конфигурация и финальное тестирование**
  - Добавить ключи в `application.properties` (токен, username бота, интервалы, cron).
  - Провести интеграционное тестирование (end-to-end) от отправки сообщения в бот до появления записи в БД.
